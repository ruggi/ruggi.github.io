<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Postgres where-not-exists ↔ count</title>
    <link rel="stylesheet" type="text/css" href="/style.css" />
  </head>
  <body>
    <div class="wrap">
      
      <div class="top">
        <a href="/">~</a>
        
        <span><a href="/blog">blog</a></span> 
      </div>
      
      <div class="main">
        <div class="meta">
          
          Thu May  5, 2022 
        </div>
        <h1 id="postgres-where-not-exists--count">Postgres where-not-exists ↔ count</h1>
<p>Talking about Postgres, here's an interesting scenario where a <code>SELECT</code> query, which intuitively should be reasonably fast in a very large table, turns out to be <em>thousands</em> times slower than a variation which should instead intuitively be a lot slower.</p>
<h2 id="exhibit-a">Exhibit A</h2>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#ff79c6">FROM</span> A
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">NOT</span> <span style="color:#ff79c6">EXISTS</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    <span style="color:#ff79c6">SELECT</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    <span style="color:#ff79c6">FROM</span> B
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    <span style="color:#ff79c6">WHERE</span> A.foo <span style="color:#ff79c6">=</span> B.foo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span><span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">10000</span>;
</span></span></code></pre><h2 id="exhibit-b">Exhibit B</h2>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#ff79c6">FROM</span> A
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#ff79c6">WHERE</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">COUNT</span>(<span style="color:#ff79c6">*</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    <span style="color:#ff79c6">FROM</span> B
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    <span style="color:#ff79c6">WHERE</span> A.foo <span style="color:#ff79c6">=</span> B.foo
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>) <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span><span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">10000</span>;
</span></span></code></pre><p>One would assume that exhibit A would be faster than exhibit B, right?</p>
<p><em>Nope</em>.</p>
<h2 id="costs">Costs</h2>
<p>Here's the cost for the first query:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>Limit (cost=5999.xx..xxxxx.xx) rows=10000 width=...)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    -&gt; Merge Anti Join (cost=5999.xx..xxxxxxxxx.xx rows=... width=...)
</span></span></code></pre><p>And here's the cost for the second query:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;"><code><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>Limit (cost=0.57..xxxxxxxx.xx rows=10000 width=...)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    -&gt; Index Scan using ... on ... (cost=0.57..xxxxxxxxx.xx rows=... width=...)
</span></span></code></pre><p>There might be something weird going on with the DB schema here, but in the real-world version of the snippets above the <code>foo</code> columns are both PKs.</p>
<p>I'm not really sure what's going on here - it's probably something silly or trivial (and I'm no PG expert in any way), but the results are quite puzzling.</p>

      </div>
    </div>
  </body>
</html>
